---
config:
  layout: dagre
---
flowchart TB
 subgraph PARSE["문서 파싱 · OCR"]
    direction TB
        P0["PDF"]
        P4{"OCR 필요 여부"}
        P5["OCR"]
        P6["PyMuPDF"]
        P3["Image, Text 추출"]
        P7["페이지 산출물 저장
        [Image/Text/JSON + manifest]"]
  end
 subgraph IMG["단어 관련 이미지 띄우기"]
    direction TB
        I0["원본 이미지 저장"]
        I1{"캡션 탐지"}
        I2["이미지 하단에 캡션 합성"]
        I3["해당 이미지 삭제"]
        I4{"그래프/표 이미지?"}
        I5["해당 이미지 삭제"]
        I7["CLIP으로 이미지 임베딩 생성"]
        I8["원하는 단어 선택"]
        I9["CLIP으로 선택한 단어 임베딩 생성"]
        I10["단어와 유사도 Top 1 이미지 띄우기"]
  end
 subgraph TR["번역"]
    direction TB
        T1["원하는 영역 선택<br>(선택 영역 하이라이트 표시)"]
        T2["읽기순 정렬"]
        T3["텍스트 결합"]
        T4{"빈 문자열?"}
        T5["경고 표시 후 종료"]
        T6["길이 제한 6000자로 슬라이스"]
        T10["LLM 호출<br>(gpt-4.1)"]
        T7{"호출 성공?"}
        T9["오류 메시지 표시"]
        T11{"언어 감지"}
        T13["영어로 번역(en)"]
        T14["한국어로 번역(ko)"]
  end
 subgraph SM["요약"]
    direction TB
        S1["원하는 영역 선택<br>(선택 영역 하이라이트 표시)"]
        S2["읽기순 정렬"]
        S3["텍스트 결합"]
        S4{"빈 문자열?"}
        S5["경고 표시 후 종료"]
        S6["길이 제한 6000자로 슬라이스"]
        S7["전처리: 공백·중복 문장 제거"]
        S8["LLM 호출<br>(gpt-4.1)"]
        S9{"호출 성공?"}
        S10["요약 결과 표시"]
        S11["오류 메시지 표시"]
  end
subgraph FB["문서 피드백"]
  direction TB
  F1["페이지 Text 로드"]
  F2["LLM이 JSON(items) 생성"]
  F3{"호출 성공?"}
  F4{"items 비었나?"}
  F5["fb mask 추가"]
  F6["앵커 매칭: wordsToAnchorBBox<br>문장 위치 추정"]
  F7["fb note 오버레이 생성<br>(제안 텍스트/닫기/수정 버튼)"]
  F8["우측 카드 목록 생성<br>(수정 /위치 이동 버튼)"]
  F15["창 닫기"]
  F16["수정"]
  F17["위치 이동"]

  F10["page, bbox, text, fontsize 전달"]
  F11["PDF에 텍스트 덮어쓰기"]
  F13["오류 메시지 표시"]
  F14["적용 가능한 피드백 없음 표시"]

  F1 -->F2 --> F3
  F3 -- 예 --> F4
  F3 -- 아니오 --> F13
  F4 -- 예 --> F14
  F4 -- 아니오 --> F5 --> F6 --> F8 
  F16 --> F10 --> F11 
F7 --> F15
F7 --> F16
F8 --> F17

F6 --> F7
end
 subgraph CHAT["챗봇"]
    direction TB
        C1["청크 분할"]
        C2["텍스트 임베딩 생성"]
        C3["PostgreSQL 저장"]
        C4["FAISS 인덱스 생성/저장"]
        C10["LLM 호출<br>(gpt-4.1)"]
        C11{"호출 성공?"}
        C14["오류 메세지 후 종료"]
        C5["사용자 질문 입력"]
        C7["질의 임베딩 생성"]
        C8["FAISS 유사도 검색"]
        C9{"상위 스코어 임계치 이상?"}
        C12["문서 근거 중심 답변"]
        C13["일반 지식 중심 답변"]
  end
    C1 --> C2
    C2 --> C3
    C3 --> C4
    C4 --> C10
    C10 --> C11
    C11 -- 예 --> C5
    C11 -- 아니오 --> C14
    C5 --> C7
    C7 --> C8
    C8 --> C9
    C9 -- 예 --> C12
    C9 -- 아니오 --> C13
    S1 --> S2
    S2 --> S3
    S3 --> S4
    S4 -- 예 --> S5
    S4 -- 아니오 --> S6
    S6 --> S7
    S7 --> S8
    S8 --> S9
    S9 -- 예 --> S10
    S9 -- 아니오 --> S11
    T1 --> T2
    T2 --> T3
    T3 --> T4
    T4 -- 예 --> T5
    T4 -- 아니오 --> T6
    T6 --> T10
    T10 --> T7
    T7 -- 예 --> T11
    T7 -- 아니요 --> T9
    T11 -- 영어 --> T14
    T11 -- 한글 --> T13
    S(["start"]) --> P0
    P0 --> P4
    P4 -- 예 --> P5
    P5 --> P3
    P4 -- 아니오 --> P6
    P6 --> P3
    P3 --> P7
    I0 --> I1
    I1 -- 예 --> I2
    I1 -- 아니오 --> I3
    I2 --> I4
    I4 -- 예 --> I5
    I4 -- 아니요 --> I7
    I7 --> I8
    I8 --> I9
    I9 --> I10
    P7 --> IMG & TR & SM & FB & CHAT
    T1@{ shape: rect}
    style PARSE color:#000000
